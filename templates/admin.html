<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DERAS Admin Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #080b10;
  --surface:  #0d1117;
  --card:     #111620;
  --border:   #1e2736;
  --accent:   #00d4ff;
  --accent2:  #0099cc;
  --green:    #00ff88;
  --red:      #ff4466;
  --orange:   #ffaa00;
  --purple:   #aa66ff;
  --text:     #e8edf5;
  --muted:    #5a6a82;
  --mono:     'JetBrains Mono', monospace;
  --sans:     'Syne', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* LAYOUT */
.layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}

/* SIDEBAR */
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:24px 0;display:flex;flex-direction:column;position:sticky;top:0;height:100vh}
.logo{padding:0 24px 28px;border-bottom:1px solid var(--border);margin-bottom:24px}
.logo-title{font-family:var(--sans);font-size:18px;font-weight:800;letter-spacing:2px;color:var(--accent)}
.logo-sub{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px;letter-spacing:1px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 24px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .2s;letter-spacing:.5px;border-left:2px solid transparent}
.nav-item:hover{color:var(--text);background:rgba(0,212,255,.04)}
.nav-item.active{color:var(--accent);background:rgba(0,212,255,.07);border-left-color:var(--accent)}
.nav-item svg{width:16px;height:16px;flex-shrink:0}
.sidebar-footer{margin-top:auto;padding:20px 24px;border-top:1px solid var(--border)}
.online-badge{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:11px;color:var(--green)}
.pulse{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.8)}}

/* MAIN */
.main{padding:32px;overflow-x:hidden}
.page{display:none}
.page.active{display:block}

/* TOP BAR */
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px}
.page-title{font-size:22px;font-weight:800;letter-spacing:1px}
.topbar-right{display:flex;align-items:center;gap:12px}

/* STATS GRID */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden;transition:border-color .2s}
.stat-card:hover{border-color:var(--accent2)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card.c-blue::before{background:var(--accent)}
.stat-card.c-green::before{background:var(--green)}
.stat-card.c-red::before{background:var(--red)}
.stat-card.c-orange::before{background:var(--orange)}
.stat-card.c-purple::before{background:var(--purple)}
.stat-label{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:800;line-height:1}
.stat-sub{font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.search-box{flex:1;min-width:200px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:9px 14px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;transition:border-color .2s}
.search-box:focus{border-color:var(--accent)}
.filter-select{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:var(--mono);font-size:12px;outline:none;cursor:pointer}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:8px;font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:.5px;cursor:pointer;border:none;transition:all .2s;white-space:nowrap}
.btn svg{width:14px;height:14px}
.btn-accent{background:var(--accent);color:#000}
.btn-accent:hover{background:#22dfff;transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border)}
.btn-ghost:hover{color:var(--text);border-color:var(--accent)}
.btn-danger{background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3)}
.btn-danger:hover{background:rgba(255,68,102,.25)}
.btn-warn{background:rgba(255,170,0,.15);color:var(--orange);border:1px solid rgba(255,170,0,.3)}
.btn-warn:hover{background:rgba(255,170,0,.25)}
.btn-success{background:rgba(0,255,136,.12);color:var(--green);border:1px solid rgba(0,255,136,.3)}
.btn-success:hover{background:rgba(0,255,136,.22)}

/* TABLE */
.table-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.table-header{display:grid;grid-template-columns:2.5fr 1fr 1.2fr 1fr 1fr 120px;padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:10px;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase}
.table-row{display:grid;grid-template-columns:2.5fr 1fr 1.2fr 1fr 1fr 120px;padding:13px 20px;border-bottom:1px solid var(--border);align-items:center;transition:background .15s;cursor:default}
.table-row:last-child{border-bottom:none}
.table-row:hover{background:rgba(0,212,255,.025)}
.table-row.is-banned{opacity:.6}
.key-text{font-family:var(--mono);font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.key-note{font-size:10px;color:var(--muted);margin-top:2px;font-family:var(--mono)}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.5px}
.badge-active{background:rgba(0,255,136,.12);color:var(--green);border:1px solid rgba(0,255,136,.25)}
.badge-expired{background:rgba(255,68,102,.1);color:var(--red);border:1px solid rgba(255,68,102,.2)}
.badge-banned{background:rgba(255,68,102,.2);color:var(--red);border:1px solid rgba(255,68,102,.4)}
.badge-unbound{background:rgba(255,170,0,.1);color:var(--orange);border:1px solid rgba(255,170,0,.2)}
.badge-lifetime{background:rgba(170,102,255,.12);color:var(--purple);border:1px solid rgba(170,102,255,.25)}
.badge-dot{width:5px;height:5px;border-radius:50%;background:currentColor}

/* DURATION TAGS */
.dur-tag{font-family:var(--mono);font-size:11px;color:var(--muted);background:var(--surface);border:1px solid var(--border);padding:2px 8px;border-radius:4px}

/* ACTION BUTTONS (in table) */
.action-group{display:flex;gap:6px;justify-content:flex-end}
.icon-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.icon-btn:hover{color:var(--text);border-color:var(--accent);background:rgba(0,212,255,.08)}
.icon-btn.danger:hover{color:var(--red);border-color:var(--red);background:rgba(255,68,102,.1)}
.icon-btn svg{width:14px;height:14px}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:space-between;margin-top:16px}
.page-info{font-family:var(--mono);font-size:12px;color:var(--muted)}
.page-btns{display:flex;gap:6px}
.page-btn{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;font-family:var(--mono);font-size:12px;transition:all .2s;display:flex;align-items:center;justify-content:center}
.page-btn:hover,.page-btn.active{background:var(--accent);color:#000;border-color:var(--accent)}
.page-btn:disabled{opacity:.3;cursor:not-allowed}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:100;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
.modal-title{font-size:16px;font-weight:800;letter-spacing:1px;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.modal-title svg{width:20px;height:20px;color:var(--accent)}
.form-group{margin-bottom:16px}
.form-label{font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;display:block}
.form-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--accent)}
.form-select{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;cursor:pointer}
.checkbox-label{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;color:var(--text)}
.checkbox-label input{width:15px;height:15px;accent-color:var(--accent);cursor:pointer}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:24px}
.modal-close{position:absolute;top:16px;right:16px}

/* LOG VIEWER */
.log-list{max-height:340px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface)}
.log-item{padding:10px 14px;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:11px;display:grid;grid-template-columns:140px 120px 1fr;gap:8px;align-items:start}
.log-item:last-child{border-bottom:none}
.log-time{color:var(--muted)}
.log-event{color:var(--accent);font-weight:700}
.log-detail{color:var(--text)}

/* BANNED HWID LIST */
.hwid-list{display:flex;flex-direction:column;gap:10px}
.hwid-item{background:var(--surface);border:1px solid rgba(255,68,102,.2);border-radius:8px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
.hwid-hash{font-family:var(--mono);font-size:11px;color:var(--text);word-break:break-all}
.hwid-meta{font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:4px}

/* TOAST */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-family:var(--mono);font-size:12px;display:flex;align-items:center;gap:10px;animation:slideUp .3s ease;max-width:320px}
.toast.success{border-left:3px solid var(--green);color:var(--green)}
.toast.error{border-left:3px solid var(--red);color:var(--red)}
.toast.info{border-left:3px solid var(--accent);color:var(--accent)}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

/* EMPTY STATE */
.empty-state{padding:60px;text-align:center;color:var(--muted);font-family:var(--mono);font-size:13px}
.empty-state svg{width:40px;height:40px;margin:0 auto 16px;opacity:.3;display:block}

/* LOADING */
.loading{text-align:center;padding:40px;font-family:var(--mono);font-size:12px;color:var(--muted)}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* GENERATE FORM */
.gen-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:460px}
.result-box{background:var(--surface);border:1px solid var(--accent);border-radius:8px;padding:14px;font-family:var(--mono);font-size:14px;color:var(--accent);word-break:break-all;cursor:pointer;position:relative}
.result-box::after{content:'CLICK TO COPY';position:absolute;top:8px;right:10px;font-size:9px;color:var(--muted);letter-spacing:1px}

@media(max-width:1100px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .table-header,.table-row{grid-template-columns:2fr 1fr 1fr .8fr 80px}
  .col-hwid{display:none}
}
@media(max-width:768px){
  .layout{grid-template-columns:1fr}
  .sidebar{display:none}
  .main{padding:16px}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
}
</style>
</head>
<body>

<div class="layout">
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-title">‚ö° DERAS</div>
    <div class="logo-sub">ADMIN PANEL v2.0</div>
  </div>
  <nav>
    <div class="nav-item active" onclick="showPage('dashboard')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 13a1 1 0 011-1h4a1 1 0 011 1v6a1 1 0 01-1 1h-4a1 1 0 01-1-1v-6z"/></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="showPage('licenses')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
      Lisensi
    </div>
    <div class="nav-item" onclick="showPage('generate')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      Generate Key
    </div>
    <div class="nav-item" onclick="showPage('banned')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
      Banned HWID
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="online-badge">
      <div class="pulse"></div>
      SERVER ONLINE
    </div>
    <div style="font-family:var(--mono);font-size:10px;color:var(--muted);margin-top:8px" id="serverTime">--</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- ===== DASHBOARD PAGE ===== -->
  <div class="page active" id="page-dashboard">
    <div class="topbar">
      <div class="page-title">Dashboard</div>
      <div class="topbar-right">
        <button class="btn btn-ghost" onclick="refreshStats()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Refresh
        </button>
      </div>
    </div>
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card c-blue"><div class="stat-label">Total Lisensi</div><div class="stat-value" id="s-total">‚Äî</div><div class="stat-sub">All time</div></div>
      <div class="stat-card c-green"><div class="stat-label">Aktif</div><div class="stat-value" id="s-active">‚Äî</div><div class="stat-sub">Saat ini valid</div></div>
      <div class="stat-card c-orange"><div class="stat-label">Menunggu</div><div class="stat-value" id="s-unbound">‚Äî</div><div class="stat-sub">Belum diaktifkan</div></div>
      <div class="stat-card c-red"><div class="stat-label">Expired</div><div class="stat-value" id="s-expired">‚Äî</div><div class="stat-sub">Habis masa</div></div>
      <div class="stat-card c-red"><div class="stat-label">Banned Key</div><div class="stat-value" id="s-banned">‚Äî</div><div class="stat-sub">Diblokir</div></div>
      <div class="stat-card c-purple"><div class="stat-label">Lifetime</div><div class="stat-value" id="s-lifetime">‚Äî</div><div class="stat-sub">Permanent</div></div>
      <div class="stat-card c-blue"><div class="stat-label">HWID Banned</div><div class="stat-value" id="s-bannedHwid">‚Äî</div><div class="stat-sub">Hardware diblokir</div></div>
      <div class="stat-card c-green"><div class="stat-label">Aktif Hari Ini</div><div class="stat-value" id="s-today">‚Äî</div><div class="stat-sub">Last 24h activity</div></div>
    </div>
  </div>

  <!-- ===== LICENSES PAGE ===== -->
  <div class="page" id="page-licenses">
    <div class="topbar">
      <div class="page-title">Manajemen Lisensi</div>
      <div class="topbar-right">
        <button class="btn btn-accent" onclick="showPage('generate')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
          Generate Key
        </button>
      </div>
    </div>
    <div class="toolbar">
      <input class="search-box" id="searchInput" placeholder="üîç  Cari license key..." oninput="debounceSearch()">
      <select class="filter-select" id="filterStatus" onchange="loadLicenses()">
        <option value="all">Semua Status</option>
        <option value="active">Aktif</option>
        <option value="expired">Expired</option>
        <option value="banned">Banned</option>
        <option value="unbound">Belum Aktif</option>
      </select>
      <select class="filter-select" id="filterDuration" onchange="loadLicenses()">
        <option value="all">Semua Durasi</option>
        <option value="lifetime">Lifetime</option>
        <option value="1month">1 Bulan</option>
        <option value="2weeks">2 Minggu</option>
        <option value="trial_6hours">Trial 6 Jam</option>
        <option value="demo_1min">Demo 1 Menit</option>
      </select>
      <button class="btn btn-ghost" onclick="loadLicenses()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
      </button>
    </div>

    <div class="table-wrap">
      <div class="table-header">
        <div>License Key</div>
        <div>Status</div>
        <div class="col-hwid">HWID</div>
        <div>Durasi</div>
        <div>Sisa Waktu</div>
        <div style="text-align:right">Aksi</div>
      </div>
      <div id="licenseTableBody">
        <div class="loading"><span class="spinner"></span>Memuat data...</div>
      </div>
    </div>

    <div class="pagination">
      <div class="page-info" id="pageInfo">‚Äî data</div>
      <div class="page-btns" id="pageBtns"></div>
    </div>
  </div>

  <!-- ===== GENERATE PAGE ===== -->
  <div class="page" id="page-generate">
    <div class="topbar">
      <div class="page-title">Generate License Key</div>
    </div>
    <div class="gen-card">
      <div class="form-group">
        <label class="form-label">Durasi Lisensi</label>
        <select class="form-select" id="genDuration">
          <option value="lifetime">üîÆ Lifetime</option>
          <option value="1month" selected>üìÖ 1 Bulan</option>
          <option value="2weeks">üìÖ 2 Minggu</option>
          <option value="trial_6hours">‚è± Trial 6 Jam</option>
          <option value="demo_1min">‚ö° Demo 1 Menit</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Catatan (Nama Buyer / Opsional)</label>
        <input class="form-input" id="genNote" placeholder="contoh: Budi - WA 0812xxx">
      </div>
      <button class="btn btn-accent" style="width:100%;justify-content:center" onclick="generateKey()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        GENERATE KEY
      </button>
      <div id="genResult" style="margin-top:16px;display:none">
        <label class="form-label">Key Berhasil Dibuat</label>
        <div class="result-box" id="genResultKey" onclick="copyKey(this)"></div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:8px" id="genResultMeta"></div>
      </div>
    </div>
  </div>

  <!-- ===== BANNED HWID PAGE ===== -->
  <div class="page" id="page-banned">
    <div class="topbar">
      <div class="page-title">Banned HWID</div>
      <div class="topbar-right">
        <button class="btn btn-ghost" onclick="loadBannedHwids()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          Refresh
        </button>
      </div>
    </div>
    <div id="bannedHwidList" class="hwid-list">
      <div class="loading"><span class="spinner"></span>Memuat...</div>
    </div>
  </div>

</main>
</div>

<!-- ===== MODAL: ACTION ===== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ==========================================
// STATE
// ==========================================
let currentPage = 1;
let totalPages  = 1;
let searchTimer = null;
let activeLicenseKey = null;

// ==========================================
// NAVIGATION
// ==========================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const navItems = document.querySelectorAll('.nav-item');
  const map = { dashboard: 0, licenses: 1, generate: 2, banned: 3 };
  if (map[name] !== undefined) navItems[map[name]].classList.add('active');

  if (name === 'dashboard') refreshStats();
  if (name === 'licenses')  { currentPage = 1; loadLicenses(); }
  if (name === 'banned')    loadBannedHwids();
}

// ==========================================
// API HELPERS
// ==========================================
async function api(method, url, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  return res.json();
}

// ==========================================
// STATS
// ==========================================
async function refreshStats() {
  const data = await api('GET', '/admin/api/stats');
  document.getElementById('s-total').textContent   = data.total      ?? '‚Äî';
  document.getElementById('s-active').textContent  = data.active     ?? '‚Äî';
  document.getElementById('s-expired').textContent = data.expired    ?? '‚Äî';
  document.getElementById('s-banned').textContent  = data.banned     ?? '‚Äî';
  document.getElementById('s-unbound').textContent = data.unbound    ?? '‚Äî';
  document.getElementById('s-lifetime').textContent= data.lifetime   ?? '‚Äî';
  document.getElementById('s-bannedHwid').textContent = data.banned_hwids ?? '‚Äî';
  document.getElementById('s-today').textContent   = data.activated_today ?? '‚Äî';
}

// ==========================================
// LICENSES TABLE
// ==========================================
function debounceSearch() {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => { currentPage = 1; loadLicenses(); }, 400);
}

async function loadLicenses() {
  const body = document.getElementById('licenseTableBody');
  body.innerHTML = '<div class="loading"><span class="spinner"></span>Memuat...</div>';

  const search   = document.getElementById('searchInput').value;
  const status   = document.getElementById('filterStatus').value;
  const duration = document.getElementById('filterDuration').value;
  const params   = new URLSearchParams({ search, status, duration, page: currentPage, per_page: 25 });

  const data = await api('GET', `/admin/api/licenses?${params}`);
  totalPages = data.pages || 1;

  document.getElementById('pageInfo').textContent =
    `${data.total} lisensi ‚Ä¢ halaman ${currentPage}/${totalPages}`;

  renderPagination();

  if (!data.licenses || data.licenses.length === 0) {
    body.innerHTML = `<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Tidak ada data ditemukan</div>`;
    return;
  }

  body.innerHTML = data.licenses.map(l => {
    const statusBadge = l.is_banned
      ? `<span class="badge badge-banned"><span class="badge-dot"></span>BANNED</span>`
      : !l.is_active
      ? `<span class="badge badge-expired"><span class="badge-dot"></span>EXPIRED</span>`
      : l.is_unbound
      ? `<span class="badge badge-unbound"><span class="badge-dot"></span>UNBOUND</span>`
      : `<span class="badge badge-active"><span class="badge-dot"></span>AKTIF</span>`;

    const durBadge = l.duration_type === 'lifetime'
      ? `<span class="badge badge-lifetime">LIFETIME</span>`
      : `<span class="dur-tag">${l.duration_type}</span>`;

    const timeLeft = l.is_active && !l.is_unbound
      ? (l.time_left || (l.duration_type === 'lifetime' ? '‚àû' : '‚Äî'))
      : '‚Äî';

    const shortKey = l.license_key.length > 28 ? l.license_key.substring(0, 28) + '‚Ä¶' : l.license_key;

    return `<div class="table-row ${l.is_banned ? 'is-banned' : ''}">
      <div>
        <div class="key-text" title="${l.license_key}">${shortKey}</div>
        ${l.note ? `<div class="key-note">üìù ${l.note}</div>` : ''}
      </div>
      <div>${statusBadge}</div>
      <div class="col-hwid" style="font-family:var(--mono);font-size:11px;color:var(--muted)">${l.hwid_short || '<span style="color:var(--muted);opacity:.5">Unbound</span>'}</div>
      <div>${durBadge}</div>
      <div style="font-family:var(--mono);font-size:12px;color:${timeLeft==='Expired'?'var(--red)':'var(--text)'}">${timeLeft}</div>
      <div class="action-group">
        <button class="icon-btn" title="Logs" onclick="showLogs('${l.license_key}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        </button>
        <button class="icon-btn" title="Aksi" onclick="showActions('${l.license_key}', ${l.is_banned}, ${l.is_active}, '${l.duration_type}', ${!!l.hwid_full})">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
        </button>
      </div>
    </div>`;
  }).join('');
}

function renderPagination() {
  const container = document.getElementById('pageBtns');
  let html = `<button class="page-btn" ${currentPage===1?'disabled':''} onclick="gotoPage(${currentPage-1})">‚Äπ</button>`;
  const start = Math.max(1, currentPage - 2);
  const end   = Math.min(totalPages, currentPage + 2);
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i===currentPage?'active':''}" onclick="gotoPage(${i})">${i}</button>`;
  }
  html += `<button class="page-btn" ${currentPage===totalPages?'disabled':''} onclick="gotoPage(${currentPage+1})">‚Ä∫</button>`;
  container.innerHTML = html;
}

function gotoPage(p) {
  if (p < 1 || p > totalPages) return;
  currentPage = p;
  loadLicenses();
}

// ==========================================
// LOGS MODAL
// ==========================================
async function showLogs(key) {
  openModal(`<div class="modal-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Activity Logs</div>
  <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:12px;word-break:break-all">${key}</div>
  <div class="log-list" id="logListInner"><div class="loading"><span class="spinner"></span></div></div>
  <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal()">Tutup</button></div>`);

  const data = await api('GET', `/admin/api/licenses/${key}/logs`);
  const logs = data.logs || [];
  const el   = document.getElementById('logListInner');

  if (!logs.length) {
    el.innerHTML = '<div class="empty-state" style="padding:20px">Belum ada log</div>';
    return;
  }

  el.innerHTML = [...logs].reverse().map(l => `
    <div class="log-item">
      <div class="log-time">${l.time.replace('T',' ').substring(0,19)}</div>
      <div class="log-event">${l.event}</div>
      <div class="log-detail">${l.detail || ''}</div>
    </div>`).join('');
}

// ==========================================
// ACTIONS MODAL
// ==========================================
function showActions(key, isBanned, isActive, durationType, hasHwid) {
  activeLicenseKey = key;
  const short = key.length > 30 ? key.substring(0, 30) + '‚Ä¶' : key;

  let btns = '';
  if (isBanned) {
    btns += `<button class="btn btn-success" style="width:100%;justify-content:center;margin-bottom:8px" onclick="doAction('unban')">‚úÖ Unban Lisensi</button>`;
  } else {
    if (hasHwid) {
      btns += `<button class="btn btn-warn" style="width:100%;justify-content:center;margin-bottom:8px" onclick="doAction('reset-hwid')">üîÑ Reset HWID</button>`;
    }
    if (isActive) {
      btns += `<button class="btn btn-warn" style="width:100%;justify-content:center;margin-bottom:8px" onclick="showExtendModal()">üìÖ Extend Durasi</button>`;
      btns += `<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-bottom:8px" onclick="showNoteModal()">üìù Edit Catatan</button>`;
      btns += `<button class="btn btn-ghost" style="width:100%;justify-content:center;margin-bottom:8px" onclick="doAction('deactivate')">‚è∏ Nonaktifkan</button>`;
      btns += `<button class="btn btn-danger" style="width:100%;justify-content:center;margin-bottom:8px" onclick="showBanModal()">üö´ Ban Lisensi</button>`;
    } else {
      btns += `<button class="btn btn-success" style="width:100%;justify-content:center;margin-bottom:8px" onclick="doAction('reactivate')">‚ñ∂Ô∏è Aktifkan Kembali</button>`;
      btns += `<button class="btn btn-danger" style="width:100%;justify-content:center;margin-bottom:8px" onclick="showBanModal()">üö´ Ban Lisensi</button>`;
    }
    btns += `<button class="btn btn-danger" style="width:100%;justify-content:center;margin-bottom:8px;border-color:var(--red)" onclick="doAction('delete')">üóë Hapus Permanen</button>`;
  }

  openModal(`<div class="modal-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Aksi Lisensi</div>
  <div style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:20px;word-break:break-all">${short}</div>
  ${btns}
  <button class="btn btn-ghost" style="width:100%;justify-content:center;margin-top:4px" onclick="closeModal()">Batal</button>`);
}

async function doAction(action) {
  const key = activeLicenseKey;
  if (!key) return;

  if (action === 'delete') {
    if (!confirm(`Hapus permanen lisensi ini?\n${key}`)) return;
    const res = await fetch(`/admin/api/licenses/${encodeURIComponent(key)}/delete`, { method: 'DELETE' });
    const data = await res.json();
    toast(data.success ? 'Lisensi dihapus' : data.message, data.success ? 'success' : 'error');
  } else {
    const data = await api('POST', `/admin/api/licenses/${encodeURIComponent(key)}/${action}`);
    toast(data.message || (data.success ? 'Berhasil' : 'Gagal'), data.success ? 'success' : 'error');
  }

  closeModal();
  loadLicenses();
  refreshStats();
}

function showBanModal() {
  document.getElementById('modalContent').innerHTML = `
    <div class="modal-title" style="color:var(--red)"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>Ban Lisensi</div>
    <div class="form-group">
      <label class="form-label">Alasan Ban</label>
      <input class="form-input" id="banReason" placeholder="Contoh: Cheat detected, share lisensi, dll">
    </div>
    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" id="banHwid">
        Ban HWID device sekaligus (user tidak bisa pakai key lain di device ini)
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Batal</button>
      <button class="btn btn-danger" onclick="submitBan()">üö´ Ban Sekarang</button>
    </div>`;
}

async function submitBan() {
  const reason  = document.getElementById('banReason').value || 'Tidak ada alasan';
  const banHwid = document.getElementById('banHwid').checked;
  const data = await api('POST', `/admin/api/licenses/${encodeURIComponent(activeLicenseKey)}/ban`, { reason, ban_hwid: banHwid });
  toast(data.message || (data.success ? 'Lisensi di-ban' : 'Gagal'), data.success ? 'success' : 'error');
  closeModal();
  loadLicenses();
  refreshStats();
}

function showExtendModal() {
  document.getElementById('modalContent').innerHTML = `
    <div class="modal-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Extend Durasi</div>
    <div class="form-group">
      <label class="form-label">Tambah Berapa Hari?</label>
      <input class="form-input" id="extendDays" type="number" value="7" min="1" max="3650" placeholder="Jumlah hari">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Batal</button>
      <button class="btn btn-accent" onclick="submitExtend()">‚úÖ Extend</button>
    </div>`;
}

async function submitExtend() {
  const days = parseInt(document.getElementById('extendDays').value) || 7;
  const data = await api('POST', `/admin/api/licenses/${encodeURIComponent(activeLicenseKey)}/extend`, { days });
  toast(data.success ? `Diperpanjang ${days} hari ‚Üí ${data.new_expires?.substring(0,10)}` : data.message, data.success ? 'success' : 'error');
  closeModal();
  loadLicenses();
}

function showNoteModal() {
  document.getElementById('modalContent').innerHTML = `
    <div class="modal-title"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Edit Catatan</div>
    <div class="form-group">
      <label class="form-label">Catatan (Nama Buyer, dll)</label>
      <input class="form-input" id="noteInput" placeholder="contoh: Budi - 0812xxx - Telegram @xxx">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Batal</button>
      <button class="btn btn-accent" onclick="submitNote()">üíæ Simpan</button>
    </div>`;
}

async function submitNote() {
  const note = document.getElementById('noteInput').value;
  const data = await api('POST', `/admin/api/licenses/${encodeURIComponent(activeLicenseKey)}/note`, { note });
  toast(data.success ? 'Catatan disimpan' : 'Gagal', data.success ? 'success' : 'error');
  closeModal();
  loadLicenses();
}

// ==========================================
// GENERATE KEY
// ==========================================
async function generateKey() {
  const duration = document.getElementById('genDuration').value;
  const note     = document.getElementById('genNote').value;
  const data     = await api('POST', '/api/generate-key', { duration_type: duration, note });

  if (data.success) {
    document.getElementById('genResult').style.display = 'block';
    document.getElementById('genResultKey').textContent = data.license_key;
    document.getElementById('genResultMeta').textContent = `Durasi: ${data.duration_type} ‚Ä¢ Aktif saat pertama digunakan`;
    toast('Key berhasil dibuat!', 'success');
    refreshStats();
  } else {
    toast(data.message || 'Gagal generate key', 'error');
  }
}

function copyKey(el) {
  navigator.clipboard.writeText(el.textContent).then(() => toast('Key disalin ke clipboard!', 'info'));
}

// ==========================================
// BANNED HWID
// ==========================================
async function loadBannedHwids() {
  const container = document.getElementById('bannedHwidList');
  container.innerHTML = '<div class="loading"><span class="spinner"></span>Memuat...</div>';
  const data = await api('GET', '/admin/api/banned-hwids');
  const list = data.banned_hwids || [];

  if (!list.length) {
    container.innerHTML = `<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Tidak ada HWID yang di-ban</div>`;
    return;
  }

  container.innerHTML = list.map(h => `
    <div class="hwid-item">
      <div>
        <div class="hwid-hash">${h.hwid_hash}</div>
        <div class="hwid-meta">Alasan: ${h.reason || '‚Äî'} ‚Ä¢ ${h.banned_at?.substring(0,19).replace('T',' ') || '‚Äî'} ‚Ä¢ Key: ${h.license_key?.substring(0,20) || '‚Äî'}</div>
      </div>
      <button class="btn btn-success" onclick="unbanHwid('${h.hwid_hash}')">Unban</button>
    </div>`).join('');
}

async function unbanHwid(hash) {
  if (!confirm('Unban HWID ini?')) return;
  const data = await api('POST', `/admin/api/banned-hwids/${hash}/unban`);
  toast(data.success ? 'HWID berhasil di-unban' : data.message, data.success ? 'success' : 'error');
  loadBannedHwids();
  refreshStats();
}

// ==========================================
// MODAL
// ==========================================
function openModal(html) {
  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  activeLicenseKey = null;
}
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

// ==========================================
// TOAST
// ==========================================
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ==========================================
// CLOCK
// ==========================================
function updateClock() {
  document.getElementById('serverTime').textContent =
    new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC';
}
setInterval(updateClock, 1000);
updateClock();

// ==========================================
// INIT
// ==========================================
refreshStats();
</script>
</body>
</html>